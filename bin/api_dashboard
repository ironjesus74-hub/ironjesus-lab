#!/data/data/com.termux/files/usr/bin/bash
source "$HOME/ironjesus-lab/lib/common.sh"
need curl

LIST_FILE="${1:-endpoints.txt}"
INTERVAL="${2:-10}"

[[ ! -f "$LIST_FILE" ]] && die "Provide a file with one URL per line."

clear

while true; do
  clear
  echo "API DASHBOARD  |  $(date)"
  echo "Refresh: ${INTERVAL}s"
  echo "-----------------------------------------------"

  while IFS= read -r URL; do
    [[ -z "$URL" ]] && continue

    RESPONSE=$(curl -o /dev/null -s -w "%{http_code} %{time_total}" "$URL")
    STATUS=$(echo "$RESPONSE" | awk '{print $1}')
    TIME=$(echo "$RESPONSE" | awk '{print $2}')

    if [[ "$STATUS" =~ ^2 ]]; then
      color green "$URL  |  $STATUS  |  ${TIME}s"
    elif [[ "$STATUS" =~ ^4|^5 ]]; then
      color red "$URL  |  $STATUS  |  ${TIME}s"
    else
      color yellow "$URL  |  $STATUS  |  ${TIME}s"
    fi

  done < "$LIST_FILE"

  sleep "$INTERVAL"
done
